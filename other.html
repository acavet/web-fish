<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="css" href="mystyle.css">
    <link rel="stylesheet" href="mystyle.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    .card {
        float:left;
        color:black;
        height: 140px; 
        aspect-ratio: 2.5/3.5;
        background: cornsilk;
        padding: 5px;
        border: 2px solid navy;
        border-radius: 5px;
        font-size: 20pt;
        position: relative;
        margin-right: -60px;
    }

    .field {
        float: left; 
        width: 70%; 
        height: 100%; 
        background: rgba(0, 0, 128, 0.5);
        border: 2px solid navy;
        border-radius: 5px;
    }
    .gameLog {
        height: 70vh; 
        width: 25%; 
        overflow: auto; 
        border: 2px solid navy; 
        border-radius: 5px; 
        float: right; 
        background: rgba(255, 255, 255, 0.25);
    }

</style>

<body>
    <h1>Fish Game</h1>

    <button onclick = "setUpGame()"> New Game </button>
    <div id = "gameContents", hidden = 'true', style = "height: 70vh">
        <div id = "playingField", class = "field">
            <table style = "width:90%; height: 90%; margin: auto; margin-top: 20px">
                <tr style = "height: 15%"> 
                    <td> <button id = "name2", class = "name"> </button> </td>
                </tr>
                <tr style = "width:100%; height: 15%">  
                    <td style = "float:left"><button onclick = "doNextTurn(this)" id = "name1", class = "name"> </button> </td>
                    <td style = "float:right"><button onclick = "doNextTurn(this)" id = "name3", class = "name"> </button> </td>
                </tr>
                <tr style = "clear: both; height: 35%">
                    <td>
                        <h2 style = "margin:auto; width:fit-content; color:wheat"> Selected Card </h2> <br>
                   
                        <select id="rankSelection"></select> 
                        &nbsp; of &nbsp;
                        <select id="suitSelection"></select>
                        <br>
    
                        <div id = "nextTurnButton", hidden = "hidden", style = "margin:auto; width:fit-content">
                            <button onclick = "doNextTurn(players)", style = "width:120px"> Next Turn </button>
                        </div>
                    </td>
                <tr style = 'height: 25%'>  
                    <td>
                        <div style = "display:block; width:fit-content; overflow-x:scroll; overflow-y:hidden height: 100%">
                            <div id = "name0" style = "display:table; height:100%"> </div>
                        </div>
                    </td>
                </tr>
                   
            </table>

        </div>

        <!-- Game Log -->
        <div class = "gameLog"> 
            <table id = "gameLogTable" style = "margin: 20px; display: inline">  
            </table>
        </div>
        
    </div>

</body>

<!-- Include Java Fish -->
<script src = "Java Fish.js"></script>

<!-- Global Variables -->
<script> 
    let currentPlayer = null
    let players = [] 
</script>

<!-- Helper functions -->
<script>

    // Todo: Based on what you can ask for?
    function updateCardSelections(players) {
        const rankSelection = document.getElementById("rankSelection");
        rankSelection.innerHTML = ""
        for (let i = 2; i < 15; i++) {
            const newOption = document.createElement("option")
            newOption.text = Card.ranks[i]
            rankSelection.appendChild(newOption)
        }

        const suitSelection = document.getElementById("suitSelection");
        suitSelection.innerHTML = ""
        for (const suit of Card.suits) {
            const newOption = document.createElement("option")
            newOption.text = suit
            suitSelection.appendChild(newOption)
        }   

    }

    // Show which cards are in your hand, and how many cards other players have
    // Currenly shows all cards to debug
    function updateHands(players) {

        for (const i in players) {
            const name = document.getElementById("name" + i)
            let player = players[i]
            name.innerHTML = ""

            if (i != 0) {
                // nameText = player.name + ": ";
                // nameText += `${player.hand.size} cards`
                // name.innerHTML = nameText
                name.innerHTML = player.name
                continue
            }

            let sortedHand = Array.from(player.hand)

            sortedHand.sort( function(a, b) {
                if (a.suit == b.suit) return a.rank - b.rank
                else return a.suit - b.suit;
            });

            for (let i = 0; i < sortedHand.length; i++) {

                let card = document.createElement("div")
                card.className = "card"
                card.innerText = sortedHand[i].symbol
                name.appendChild(card)

                if (i == sortedHand.length-1) {
                    card.style.margin = "0px";
                }
            }
            
        }

    }

    // Updates whether "Ask" or "Next Turn" is divisble
    function updateVisibleButtons() {
        if (currentPlayer.isComputer) {
            thing = document.getElementById("name1").disabled = true
            document.getElementById("name3").disabled = true
            document.getElementById("nextTurnButton").hidden = false
        } else {
            document.getElementById("name1").disabled = false
            document.getElementById("name3").disabled = false
            document.getElementById("nextTurnButton").hidden = "hidden"
        }
    }

    // Gets target based on selection
    function getTarget(name) {
        for (const player of players) {
            if (player.name == name) {
                return player
            }
        }
    }

    // Gets card based on selection
    function getCard() {
        let rank = document.getElementById("rankSelection").selectedIndex + 2
        let suit = document.getElementById("suitSelection").selectedIndex
        return new Card(rank, suit)
    }

</script>

<!-- setUpGame() -->
<script>
    function setUpGame() {
        document.getElementById("gameContents").hidden = false
        document.getElementById("gameLogTable").innerHTML = ""
        players = setUpPlayers(["Huit", "Conan", "Ana", "Hasan"], [false, true, true, true])
        currentPlayer = players[0]
        updateCardSelections(players)
        dealCards(players)
        updateHands(players)
        updateVisibleButtons()
    }
</script>

<!-- doNextTurn() -->
<script>
    function doNextTurn(button = undefined) {
        let target = null
        let card = null

        if (currentPlayer.isComputer) {
            target = currentPlayer.getComputerTarget(players)
            card = currentPlayer.getComputerCard(target)
            // tryComputerDeclare(currentPlayer, players)
        } else {
            target = getTarget(button.textContent)
            card = getCard()
        }

        const logTable = document.getElementById("gameLogTable")
        let row = logTable.insertRow(0);
        

        result = currentPlayer.askForCard(target, card, players)

        if (result != null) {
            row.innerHTML = `${currentPlayer.name}: ${target.name}, do you have the ${card.symbol}? <br>`
        } else {
            alert("You can't ask for that card")
        }

        updateHands(players)

        
        row = logTable.insertRow(1);

        if (result == false) {
            row.innerHTML = `${target.name}: no. <br><br>`
            currentPlayer = target
        } else if (result == true) {
            row.innerHTML = `${target.name}: yes. <br><br>`
        }
        updateVisibleButtons()
    }

</script>

<script>
    function declareSet() {
        const card = getCard()
        players[0].declareSet(card, players)
        updateHands(players)
    }
</script>
