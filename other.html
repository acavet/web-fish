<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="css" href="mystyle.css">
    <link rel="stylesheet" href="mystyle.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Fish Game</h1>

    <!-- <button> New Game </button> [Generated ID here]
    <br>
    <button> Join Game </button> <input placeholder = "Game ID">
    <br>
    <ul>
        <li> player1 </li>
        <li> player2 </li>
    </ul>
     -->

    <button onclick = "setUpGame()"> Start Game </button>


    <!-- all game contents,Â hidden until game starts -->
    <div id = "gameContents", style = "height: 80vh; display:none; justify-content:space-between;">
        <!-- cards, players, etc. -->
        <div id = "playingField", class = "field">
            <div, class = "gameFlexBox">

                <button onclick = "declareSet()", id = "name2", class = "name"> </button>
                
                <div id = "middleRow" style = "display:flex; justify-content:space-between; align-items:center; width:100%; flex-grow:2">
                    <button onclick = "doNextTurn(this)", id = "name1", class = "name"></button>
                    <div id = "setsDiv", style = "display:flex; justify-content:space-around; gap: 10px"> </div>
                    <button onclick = "doNextTurn(this)", id = "name3", class = "name"></button>
                </div>
                Selected Card:
                <div style = height: fit-content>
                    <select id="rankSelection"></select> &nbsp; of &nbsp; <select id="suitSelection"></select>
                </div>

                <p id = "scoreBoard", style="height: fit-content; position: absolute; top: 10px; left: 10px; margin: 0px"> Score: 0 - 0 </p>

                <button id="nextTurnButton" onclick = "doNextTurn(players)", style = "height: fit-content; position: absolute; top: 10px; right: 10px"> Next Turn </button>
            
                <div id = "name0" style = "display:flex; justify-content:center; width:100%; overflow:scroll"> </div>
            </div>

             <!-- log of interactions -->
            <div class = "gameLog"> 
                <table id = "gameLogTable", style = "width: 100%; font-size: 16px"> </table>
            </div>
        </div>
    </div>
</body>

<!-- Include Java Fish -->
<script src = "Java Fish.js"></script>

<!-- Global Variables -->
<script> 
    let currentPlayer = null
    let players = [] 
</script>

<!-- Helper functions -->
<script>

    // Todo: Based on what you can ask for?
    function updateCardSelections(players) {
        const rankSelection = document.getElementById("rankSelection");
        rankSelection.innerHTML = ""
        for (let i = 2; i < 15; i++) {
            const newOption = document.createElement("option")
            newOption.text = Card.ranks[i]
            rankSelection.appendChild(newOption)
        }

        const suitSelection = document.getElementById("suitSelection");
        suitSelection.innerHTML = ""
        for (const suit of Card.suits) {
            const newOption = document.createElement("option")
            newOption.text = suit
            suitSelection.appendChild(newOption)
        }   

    }

    // Show which cards are in your hand, and how many cards other players have
    // Currenly shows all cards to debug
    function updateHands(players) {

        for (const i in players) {
            const name = document.getElementById("name" + i)
            let player = players[i]
            name.innerHTML = ""

            if (i != 0) {
                // nameText = player.name + ": ";
                // nameText += `${player.hand.size} cards`
                // name.innerHTML = nameText
                name.innerHTML = player.name
                continue
            }
            
            for (let i = 0; i < player.sortedHand.length; i++) {

                let card = document.createElement("div")
                card.className = "card"
                card.innerText = player.sortedHand[i].symbol
                name.appendChild(card)

                if (i == player.sortedHand.length-1) {
                    card.style.margin = "0px";
                }
            }
            
        }

    }

    // Updates whether "Ask" or "Next Turn" is divisble
    function updateVisibleButtons() {
        if (currentPlayer.isComputer) {
            thing = document.getElementById("name1").disabled = true
            document.getElementById("name3").disabled = true
            document.getElementById("nextTurnButton").disabled = false
        } else {
            document.getElementById("name1").disabled = false
            document.getElementById("name3").disabled = false
            document.getElementById("nextTurnButton").disabled = true
        }
    }

    // Gets target based on selection
    function getTarget(name) {
        for (const player of players) {
            if (player.name == name) {
                return player
            }
        }
    }

    // Gets card based on selection
    function getCard() {
        let rank = document.getElementById("rankSelection").selectedIndex + 2
        let suit = document.getElementById("suitSelection").selectedIndex

        const theCard = new Card(rank, suit)

        for (const card of deck) {
            if (card.equals(theCard)) return card
        }

        assert(false)
    }

</script>

<!-- setUpGame() -->
<script>
    function setUpGame() {
        document.getElementById("gameContents").style.display = "flex"
        document.getElementById("gameLogTable").innerHTML = ""
        players = setUpPlayers(["Huit", "Conan", "Ana", "Hasan"], [false, true, true, true])
        currentPlayer = players[0]
        updateCardSelections(players)
        dealCards(players)
        updateHands(players)
        updateVisibleButtons()
    }
</script>

<!-- doNextTurn() -->
<script>
    function doNextTurn(button = undefined) {
        let target = null
        let card = null

        if (currentPlayer.isComputer) {
            currentPlayer.tryComputerDeclare(players)
            target = currentPlayer.getComputerTarget(players)
            card = currentPlayer.getComputerCard(target)
        } else {
            target = getTarget(button.textContent)
            card = getCard()
        }

       
        result = currentPlayer.askForCard(target, card, players)

        if (result == null) {
            currentPlayer = findNextPlayer(currentPlayer)
            return
        }

        const logTable = document.getElementById("gameLogTable")
        let row = logTable.insertRow(0);
        let cell = row.insertCell(0)
        cell.innerHTML = `<b>${currentPlayer.name}:</b> ${card.symbol}? <br>`
        

        updateHands(players)
        cell.innerHTML += `<b>${target.name}: <b>`

        if (result == false) {
            cell.innerHTML += "no."
            currentPlayer = findNextPlayer(target)
        } else if (result == true) {
            cell.innerHTML += "yes."
            currentPlayer = findNextPlayer(currentPlayer)
        }
        updateVisibleButtons()
    }

</script>

<script>
    function declareSet() {
        const card = getCard()
        players[0].declareSet(card, players)
        updateHands(players)

        let name3 = document.getElementById("name3")

        let setsDiv = document.getElementById("setsDiv")
        let setDiv = document.createElement("div")
        setDiv.style = "position:relative; width: 100px; height: 100px"

        for (const c of card.set) {
            let cardDiv = document.createElement("div")
            cardDiv.classList.add("smallCard")
            const rotateAmount = -15 + Math.floor(Math.random() * 30)
            cardDiv.style.transform = `rotate(${rotateAmount}deg)`
            cardDiv.innerText = c.symbol
            setDiv.appendChild(cardDiv)
        }

        setsDiv.appendChild(setDiv)

        document.getElementById("scoreBoard").textContent = `Score: ${players[0].points + players[2].points} - ${players[1].points + players[3].points}`
    }
</script>