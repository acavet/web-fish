<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="css" href="mystyle.css">
    <link rel="stylesheet" href="mystyle.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>Fish Game</h1>

    <button onclick = "generateGameID()"> New Game </button>
    <p id = "gameId"></p>
    <br>
    <button onclick = "joinGame()"> Join Game </button> 
    <input id = "joinGameId", placeholder = "Game ID">
    <input id = "joinGameName", placeholder = "Name">
    <br>
    <ul>
        <li id = "player0"></li>
        <li id = "player1"></li>
        <li id = "player2"></li>
        <li id = "player3"></li>
    </ul>
    

    <button onclick = "startGame()"> Start Game </button>


    <!-- all game contents,Â hidden until game starts -->
    <div id = "gameContents", style = "height: 80vh; display:none; justify-content:space-between;">
        <!-- cards, players, etc. -->
        <div id = "playingField", class = "field">
            <div, class = "gameFlexBox">

                <button onclick = "declareSet()", id = "name2", class = "name"> </button>
                
                <div id = "middleRow" style = "display:flex; justify-content:space-between; align-items:center; width:100%; flex-grow:2">
                    <button onclick = "doNextTurn(this)", id = "name1", class = "name"></button>
                    <div id = "setsDiv", style = "display:flex; justify-content:space-around; gap: 10px"> </div>
                    <button onclick = "doNextTurn(this)", id = "name3", class = "name"></button>
                </div>
                Selected Card:
                <div style = height: fit-content>
                    <select id="rankSelection"></select> &nbsp; of &nbsp; <select id="suitSelection"></select>
                </div>

                <p id = "scoreBoard", style="height: fit-content; position: absolute; top: 10px; left: 10px; margin: 0px"> Score: 0 - 0 </p>

                <button id="nextTurnButton" onclick = "doNextTurn(players)", style = "height: fit-content; position: absolute; top: 10px; right: 10px"> Next Turn </button>
            
                <div id = "name0" style = "display:flex; justify-content:center; width:100%; overflow:scroll"> </div>
            </div>

             <!-- log of interactions -->
            <div class = "gameLog"> 
                <table id = "gameLogTable", style = "width: 100%; font-size: 16px"> </table>
            </div>
        </div>
    </div>
</body>

<!-- Include Java Fish -->
<script src = "Java Fish.js"></script>

<!-- Global Variables -->
<script> 
    let thisPlayer = null
</script>

<!-- Update functions -->
<script>
    // Todo: Based on what you can ask for?
    function updateCardSelections(game) {
        const rankSelection = document.getElementById("rankSelection");
        rankSelection.innerHTML = ""
        for (let i = 2; i < 15; i++) {
            const newOption = document.createElement("option")
            newOption.text = Card.ranks[i]
            rankSelection.appendChild(newOption)
        }

        const suitSelection = document.getElementById("suitSelection");
        suitSelection.innerHTML = ""
        for (const suit of Card.suits) {
            const newOption = document.createElement("option")
            newOption.text = suit
            suitSelection.appendChild(newOption)
        }   

    }

    // Show which cards are in your hand, and (todo) how many cards other players have
    function updateHands(game) {

        console.log(thisPlayer)
        console.log(thisPlayer.hand[0])
        document.getElementById("name1").innerText = thisPlayer.opponents[0].name
        document.getElementById("name2").innerText = thisPlayer.partner.name
        document.getElementById("name3").innerText = thisPlayer.opponents[1].name
    
        const handDiv = document.getElementById("name0")
        handDiv.innerHTML = ""
        
        for (let i = 0; i < thisPlayer.hand.length; i++) {

            let card = document.createElement("div")
            card.className = "card"
            card.innerText = thisPlayer.hand[i].symbol
            handDiv.appendChild(card)
            if (i == thisPlayer.hand.length-1) {
                card.style.margin = "0px";
            }
        }
        
    }

    // Updates whether "Ask" or "Next Turn" is divisble
    function updateVisibleButtons(game) {
        if (game.currentPlayer.isComputer) {
            document.getElementById("name1").disabled = true
            document.getElementById("name3").disabled = true
            document.getElementById("nextTurnButton").disabled = false
        } else {
            document.getElementById("name1").disabled = false
            document.getElementById("name3").disabled = false
            document.getElementById("nextTurnButton").disabled = true
        }
    }

</script>

<!-- Input functions -->
<script>

    // Gets target based on selection
    function getTarget(name) {
        for (const player of players) {
            if (player.name == name) {
                return player
            }
        }
    }

    // Gets card based on selection
    function getCard() {
        let rank = document.getElementById("rankSelection").selectedIndex + 2
        let suit = document.getElementById("suitSelection").selectedIndex

        const theCard = new Card(rank, suit)

        for (const card of deck) {
            if (card.equals(theCard)) return card
        }

        assert(false)
    }
</script>

<!-- doNextTurn() -->
<script>
    function doNextTurn(button = undefined) {
        let target = null
        let card = null

        if (currentPlayer.isComputer) {
            currentPlayer.tryComputerDeclare(players)
            target = currentPlayer.getComputerTarget(players)
            card = currentPlayer.getComputerCard(target)
        } else {
            target = getTarget(button.textContent)
            card = getCard()
        }

       
        result = currentPlayer.askForCard(target, card, players)

        if (result == null) {
            currentPlayer = findNextPlayer(currentPlayer)
            return
        }

        const logTable = document.getElementById("gameLogTable")
        let row = logTable.insertRow(0);
        let cell = row.insertCell(0)
        cell.innerHTML = `<b>${currentPlayer.name}:</b> ${card.symbol}? <br>`
        

        updateHands(players)
        cell.innerHTML += `<b>${target.name}: <b>`

        if (result == false) {
            cell.innerHTML += "no."
            currentPlayer = findNextPlayer(target)
        } else if (result == true) {
            cell.innerHTML += "yes."
            currentPlayer = findNextPlayer(currentPlayer)
        }
        updateVisibleButtons()
    }

</script>

<script>
    function declareSet() {
        const card = getCard()
        thisPlayer.declareSet(card, players)
        updateHands(players)

        let name3 = document.getElementById("name3")

        let setsDiv = document.getElementById("setsDiv")
        let setDiv = document.createElement("div")
        setDiv.style = "position:relative; width: 100px; height: 100px"

        for (const c of card.set) {
            let cardDiv = document.createElement("div")
            cardDiv.classList.add("smallCard")
            const rotateAmount = -15 + Math.floor(Math.random() * 30)
            cardDiv.style.transform = `rotate(${rotateAmount}deg)`
            cardDiv.innerText = c.symbol
            setDiv.appendChild(cardDiv)
        }

        setsDiv.appendChild(setDiv)

        document.getElementById("scoreBoard").textContent = `Score: ${thisPlayer.points + thisPlayer.partner.points} - ${thisPlayer.opponents[0].points + thisPlayer.opponents[1].points}`
    }

</script>

<script>
    let ws = new WebSocket("ws://localhost:9090")
    let clientId = null
    let gameId = null

    const reviver = function(key, value) {
        
        if (value.name !== undefined) {
            console.log("it's a player!")

            let player = new Player(value.name)
            player.hand = value.hand
            player.cardStatusD
            player.points = value.points
            player.cardStatusDictionary = value.cardStatusDictionary
            player.isComputer = value.isComputer

            return player
            
        }

        return value;
    }

    function generateGameID() {
        const payload = {
            "method": "create",
            "clientId": clientId
        }
        ws.send(JSON.stringify(payload))
    }

    function joinGame() {
        // If not already in a game, read text in from box
        const newId = document.getElementById("joinGameId").value

        if (gameId === null && newId != "") {
            gameId = newId;
            name = document.getElementById("joinGameName").value
        }

        // Join game
        const payload = {
            "method": "join",
            "clientId": clientId,
            "name": name,
            "gameId": gameId
        }
        ws.send(JSON.stringify(payload))
    }

    function startGame() {
        const payload = {
            "method": "startGame",
            "gameId": gameId
        }
        ws.send(JSON.stringify(payload));

    }

    function updateGame(game) {
        updateVisibleButtons(game)
        updateCardSelections(game)
        updateHands(game)

    }

    function setUpGame(game) {
        document.getElementById("gameContents").style.display = "flex"
        document.getElementById("gameLogTable").innerHTML = ""


        for (const player of game.players) {
            if (player.name == document.getElementById("joinGameName").value) {
                thisPlayer = player
            }
        }

        
    }

    ws.onmessage = message => {
        const response = JSON.parse(message.data, reviver);

        if (response.game !== undefined) {
            for (const player of response.game.players) {
                player.getPartners(response.game.players)
            }
        }

        switch (response.method) {
            case "create":
                document.getElementById("gameId").textContent = response.game.id;
                document.getElementById("joinGameId").value = response.game.id;
                break;
            case "connect":
                clientId = response.clientId;
                break;
            case "playerJoined":
                const game = response.game;
                let nameList = game.clients.map(client => client.name);
                for (let i = 0; i < nameList.length; i++) {
                    document.getElementById("player" + i).textContent = nameList[i]
                }
                break;
            case "gameStarted":
                setUpGame(response.game)
                updateGame(response.game)
                break;
            case "update":
                updateGame(response.game)
                break;
        }
    }
    


</script>