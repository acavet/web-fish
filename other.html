<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="css" href="mystyle.css">
    <link rel="stylesheet" href="mystyle.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    .card {
        float:left;
        color:black;
        height: 140px; 
        aspect-ratio: 2.5/3.5;
        background: cornsilk;
        padding: 5px;
        border: 2px solid navy;
        border-radius: 5px;
        font-size: 20pt;
        position: relative;
        margin-right: -60px;
    }

    .field {
        height: 100%; 
        background: rgba(0, 0, 128, 0.5);
        border: 2px solid navy;
        border-radius: 5px;
        color:wheat;
        font-size: 16pt;
        display: flex; 
        justify-content: space-between; 
        flex-grow:2;
        position: relative
    }

    .gameFlexBox {
        width: 100%;
        margin: 50px;
        margin-bottom: 10px;
        display:flex; 
        justify-content: space-between; 
        flex-direction:column;
        align-items:center;
        gap: 10px;
    }

    .gameLog {
        height: 70vh; 
        width: fit-content; 
        overflow: auto; 
        float: right; 
        border: 2px solid navy;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.25);
    }


</style>

<body>
    <h1>Fish Game</h1>

    <button onclick = "setUpGame()"> New Game </button>
    <div id = "gameContents", style = "height: 70vh; display:none; justify-content:space-between;">
        <div id = "playingField", class = "field">
            <div, class = "gameFlexBox">
                <button onclick = "declareSet()", id = "name2", class = "name"> </button>
                <div style = "display:flex; justify-content:space-between; align-items:center; width:100%; flex-grow:2">
                    <button onclick = "doNextTurn(this)", id = "name1", class = "name"></button>
                    <button onclick = "doNextTurn(this)", id = "name3", class = "name"></button>
                </div>
                Selected Card:
                <div style = height: fit-content>
                    <select id="rankSelection"></select> &nbsp; of &nbsp; <select id="suitSelection"></select>
                </div>

                <button id="nextTurnButton" onclick = "doNextTurn(players)", style = "height: fit-content; position: absolute; top: 10px; right: 10px"> Next Turn </button>
            
                <div id = "name0" style = "display:flex; justify-content:center; width:100%; overflow:scroll"> </div>
            </div>

            <div class = "gameLog"> 
                <table id = "gameLogTable", style = "width:fit-content"> </table>
            </div>
        </div>

        
        
    </div>
</body>

<!-- Include Java Fish -->
<script src = "Java Fish.js"></script>

<!-- Global Variables -->
<script> 
    let currentPlayer = null
    let players = [] 
</script>

<!-- Helper functions -->
<script>

    // Todo: Based on what you can ask for?
    function updateCardSelections(players) {
        const rankSelection = document.getElementById("rankSelection");
        rankSelection.innerHTML = ""
        for (let i = 2; i < 15; i++) {
            const newOption = document.createElement("option")
            newOption.text = Card.ranks[i]
            rankSelection.appendChild(newOption)
        }

        const suitSelection = document.getElementById("suitSelection");
        suitSelection.innerHTML = ""
        for (const suit of Card.suits) {
            const newOption = document.createElement("option")
            newOption.text = suit
            suitSelection.appendChild(newOption)
        }   

    }

    // Show which cards are in your hand, and how many cards other players have
    // Currenly shows all cards to debug
    function updateHands(players) {

        for (const i in players) {
            const name = document.getElementById("name" + i)
            let player = players[i]
            name.innerHTML = ""

            if (i != 0) {
                // nameText = player.name + ": ";
                // nameText += `${player.hand.size} cards`
                // name.innerHTML = nameText
                name.innerHTML = player.name
                continue
            }

            let sortedHand = Array.from(player.hand)

            sortedHand.sort( function(a, b) {
                if (a.suit == b.suit) return a.rank - b.rank
                else return a.suit - b.suit;
            });

            for (let i = 0; i < sortedHand.length; i++) {

                let card = document.createElement("div")
                card.className = "card"
                card.innerText = sortedHand[i].symbol
                name.appendChild(card)

                if (i == sortedHand.length-1) {
                    card.style.margin = "0px";
                }
            }
            
        }

    }

    // Updates whether "Ask" or "Next Turn" is divisble
    function updateVisibleButtons() {
        if (currentPlayer.isComputer) {
            thing = document.getElementById("name1").disabled = true
            document.getElementById("name3").disabled = true
            document.getElementById("nextTurnButton").disabled = false
        } else {
            document.getElementById("name1").disabled = false
            document.getElementById("name3").disabled = false
            document.getElementById("nextTurnButton").disabled = true
        }
    }

    // Gets target based on selection
    function getTarget(name) {
        for (const player of players) {
            if (player.name == name) {
                return player
            }
        }
    }

    // Gets card based on selection
    function getCard() {
        let rank = document.getElementById("rankSelection").selectedIndex + 2
        let suit = document.getElementById("suitSelection").selectedIndex
        return new Card(rank, suit)
    }

</script>

<!-- setUpGame() -->
<script>
    function setUpGame() {
        document.getElementById("gameContents").style.display = "flex"
        document.getElementById("gameLogTable").innerHTML = ""
        players = setUpPlayers(["Huit", "Conan", "Ana", "Hasan"], [false, true, true, true])
        currentPlayer = players[0]
        updateCardSelections(players)
        dealCards(players)
        updateHands(players)
        updateVisibleButtons()
    }
</script>

<!-- doNextTurn() -->
<script>
    function doNextTurn(button = undefined) {
        let target = null
        let card = null

        if (currentPlayer.isComputer) {
            target = currentPlayer.getComputerTarget(players)
            card = currentPlayer.getComputerCard(target)
            // tryComputerDeclare(currentPlayer, players)
        } else {
            target = getTarget(button.textContent)
            card = getCard()
        }

        const logTable = document.getElementById("gameLogTable")
        let row = logTable.insertRow(0);
        let cell = row.insertCell(0)
        

        result = currentPlayer.askForCard(target, card, players)

        if (result != null) {
            cell.innerHTML = `<b>${currentPlayer.name}:</b> ${card.symbol}? <br>`
        } else {
            alert("You can't ask for that card")
            return
        }

        updateHands(players)
        cell.innerHTML += `<b>${target.name}: <b>`

        if (result == false) {
            cell.innerHTML += "no."
            currentPlayer = target
        } else if (result == true) {
            cell.innerHTML += "yes."

        }
        updateVisibleButtons()
    }

</script>

<script>
    function declareSet() {
        const card = getCard()
        players[0].declareSet(card, players)
        updateHands(players)
    }
</script>